<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Check drupal by cytopia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Check drupal</h1>
      <h2 class="project-tagline">Nagios drupal plugin to monitor the state of a drupal site for security updates, core errors and more</h2>
      <a href="https://github.com/cytopia/check_drupal" class="btn">View on GitHub</a>
      <a href="https://github.com/cytopia/check_drupal/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/cytopia/check_drupal/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="check_drupal" class="anchor" href="#check_drupal" aria-hidden="true"><span class="octicon octicon-link"></span></a>check_drupal</h1>

<p>Nagios drupal plugin to monitor the state of a drupal site for security updates, system updates, core errors, core warnings and missing db updates.</p>

<p><a href="https://travis-ci.org/cytopia/check_drupal"><img src="https://travis-ci.org/cytopia/check_drupal.svg?branch=master" alt="Build Status"></a>
 <a href="https://packagist.org/packages/cytopia/check_drupal"><img src="https://poser.pugx.org/cytopia/check_drupal/v/stable" alt="Latest Stable Version"></a> <a href="https://packagist.org/packages/cytopia/check_drupal"><img src="https://poser.pugx.org/cytopia/check_drupal/downloads" alt="Total Downloads"></a> <a href="https://packagist.org/packages/cytopia/check_drupal"><img src="https://poser.pugx.org/cytopia/check_drupal/v/unstable" alt="Latest Unstable Version"></a> <a href="http://opensource.org/licenses/MIT"><img src="https://poser.pugx.org/cytopia/check_drupal/license" alt="License"></a>
 <a href="https://en.wikipedia.org/?title=POSIX"><img src="https://img.shields.io/badge/posix-100%25-brightgreen.svg" alt="POSIX"></a>
 <a href="https://en.wikipedia.org/?title=Bourne_shell"><img src="https://img.shields.io/badge/type-%2Fbin%2Fsh-red.svg" alt="Type"></a></p>

<h5>
<a id="note" class="anchor" href="#note" aria-hidden="true"><span class="octicon octicon-link"></span></a>NOTE</h5>

<p>This check can be used in two ways:</p>

<ol>
<li>Let nagios always trigger <code>check_drupal</code> which might take 1-3 seconds and cause some load</li>
<li>Let nagios simply parse the logfile (with <code>check_drupal_log</code>) created by <code>check_drupal</code> via cron on the target machine.</li>
</ol>

<p>I would recommend the second option as you do not check each drupal site every 5 minutes and also in order to keep the nagios check as fast as possible. For that use cron to trigger the <code>check_drupal</code> on the target machine every 6 hours or so.</p>

<h5>
<a id="requirements" class="anchor" href="#requirements" aria-hidden="true"><span class="octicon octicon-link"></span></a>Requirements</h5>

<table>
<thead>
<tr>
<th>Program</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>bourne shell (sh)</td>
<td>yes</td>
<td>The whole script is written in pure bourne shell (sh) and is 100% Posix compliant</td>
</tr>
<tr>
<td><a href="https://www.monitoring-plugins.org/doc/man/check_by_ssh.html">check_by_ssh</a></td>
<td>yes</td>
<td>This nagios plugin is used as a wrapper to check on remote hosts</td>
</tr>
<tr>
<td><a href="http://www.drush.org">drush</a></td>
<td>yes</td>
<td>This nagios plugin requires drush to be installed on the target machine</td>
</tr>
</tbody>
</table>

<h5>
<a id="features" class="anchor" href="#features" aria-hidden="true"><span class="octicon octicon-link"></span></a>Features</h5>

<ul>
<li>Check for Drupal security updates</li>
<li>Check for Drupal system updates</li>
<li>Check for Drupal required database updates</li>
<li>Check for Drupal core errors</li>
<li>Check for Drupal core warnings</li>
<li>Every check can specify its own nagios severity (Error or Warning)</li>
<li>Custom name for nagios short output</li>
<li>Detailed information in nagios long output</li>
<li>Be able to successfully recognize valid Drupal6 or Drupal7 document root</li>
<li>Basic performance data fow: how many OKs, Errors, Warnings and Unknowns</li>
</ul>

<h2>
<a id="1-usage" class="anchor" href="#1-usage" aria-hidden="true"><span class="octicon octicon-link"></span></a>1. Usage</h2>

<h3>
<a id="11-check_drupal" class="anchor" href="#11-check_drupal" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.1 <code>check_drupal</code>
</h3>

<p>With <code>-l</code> you will be able to run the <code>check_drupal</code> locally on each machine only a few times a day and dump the output to a logfile.
This file can then be checked normaly via nagios by calling <code>check_drupal_log</code> instead, which will just read the log and not put any load onto the machine.
Multiple logfiles for multiple drupal site per server will be possible.</p>

<div class="highlight highlight-source-shell"><pre>Usage: check_drupal -d <span class="pl-k">&lt;</span>drupal root<span class="pl-k">&gt;</span> [-n <span class="pl-k">&lt;</span>name<span class="pl-k">&gt;</span>] [-s <span class="pl-k">&lt;</span>w<span class="pl-k">|</span>e<span class="pl-k">&gt;</span>] [-u <span class="pl-k">&lt;</span>w<span class="pl-k">|</span>e<span class="pl-k">&gt;</span>] [-e <span class="pl-k">&lt;</span>w<span class="pl-k">|</span>e<span class="pl-k">&gt;</span>] [-w <span class="pl-k">&lt;</span>w<span class="pl-k">|</span>e<span class="pl-k">&gt;</span>] [-m <span class="pl-k">&lt;</span>w<span class="pl-k">|</span>e<span class="pl-k">&gt;</span>] [-l <span class="pl-k">&lt;</span>log file<span class="pl-k">&gt;</span>]
OR     check_drupal --check
OR     check_drupal --help
OR     check_drupal --version

Nagios plugin that will check drupal sites <span class="pl-k">for</span> errors.
Errors include the following: available security updates,
missed database updates and drupal status errors.
For each check you can specify the nagios severity (error or warning).

  -d <span class="pl-k">&lt;</span>drupal root<span class="pl-k">&gt;</span>       The full path to the drupal document root (usually
                         the <span class="pl-s"><span class="pl-pds">'</span>drupal<span class="pl-pds">'</span></span> folder. This parameter is required.

  -n <span class="pl-k">&lt;</span>name<span class="pl-k">&gt;</span>              [optional] Specify a name <span class="pl-k">for</span> the drupal instance to
                         appear on the nagios output. The default is <span class="pl-s"><span class="pl-pds">'</span>Drupal<span class="pl-pds">'</span></span>

                         the <span class="pl-s"><span class="pl-pds">'</span>drupal<span class="pl-pds">'</span></span> folder. This parameter is required.

  -s <span class="pl-k">&lt;</span>w<span class="pl-k">|</span>e<span class="pl-k">&gt;</span>               [optional] Check <span class="pl-k">for</span> drupal core and module security
                         updates and <span class="pl-k">return</span> nagios error or warning.
                         Warning:  -s w
                         Error:    -s e

  -u <span class="pl-k">&lt;</span>w<span class="pl-k">|</span>e<span class="pl-k">&gt;</span>               [optional] Check <span class="pl-k">for</span> drupal core and module updates
                         <span class="pl-k">in</span> general and <span class="pl-k">return</span> nagios error or warning.
                         Warning:  -u w
                         Error:    -u e

  -e <span class="pl-k">&lt;</span>w<span class="pl-k">|</span>e<span class="pl-k">&gt;</span>               [optional] Check <span class="pl-k">for</span> drupal status errors and <span class="pl-k">return</span>
                         nagios error or warning.
                         Warning:  -e w
                         Error:    -e e

  -w <span class="pl-k">&lt;</span>w<span class="pl-k">|</span>e<span class="pl-k">&gt;</span>               [optional] Check <span class="pl-k">for</span> drupal status warnings and <span class="pl-k">return</span>
                         nagios error or warning.
                         Warning:  -w w
                         Error:    -w e

  -m <span class="pl-k">&lt;</span>w<span class="pl-k">|</span>e<span class="pl-k">&gt;</span>               [optional] Check <span class="pl-k">for</span> drupal missed database updates
                         and <span class="pl-k">return</span> nagios error or warning. (They can occur
                         when you update core or modules and forget the db).
                         Warning:  -m w
                         Error:    -m e

  -l <span class="pl-k">&lt;</span>log file<span class="pl-k">&gt;</span>          [optional] Instead of checking all of the above via nagios
                         every five minutes or so, run this script via cron once a day
                         (or twice) and write the output into a logfile. This logfile can
                         <span class="pl-k">then</span> be checked by the nagios plugin <span class="pl-s"><span class="pl-pds">'</span>check_drupal_log<span class="pl-pds">'</span></span> which is
                         less costy <span class="pl-k">in</span> terms of load/cpu.
                         See <span class="pl-s"><span class="pl-pds">'</span>check_drupal_log --help<span class="pl-pds">'</span></span> <span class="pl-k">for</span> more info.
                         Example:
                         check_drupal -d /var/www -s e -e e -w w -l /var/log/drupal.log
                         check_drupal_log -l /var/log/drupal.log

  --check                Check <span class="pl-k">for</span> program requirements.
  --help                 Show this <span class="pl-c1">help</span>
  --version              Show version information.</pre></div>

<h3>
<a id="12-check_drupal_log" class="anchor" href="#12-check_drupal_log" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.2 <code>check_drupal_log</code>
</h3>

<div class="highlight highlight-source-shell"><pre>Usage: check_drupal_log -f <span class="pl-k">&lt;</span>logfile<span class="pl-k">&gt;</span>
OR     check_drupal_log --help
OR     check_drupal_log --version

Nagios plugin that will parse the logfile created by <span class="pl-s"><span class="pl-pds">'</span>check_drupal<span class="pl-pds">'</span></span>.

  -f <span class="pl-k">&lt;</span>logfile<span class="pl-k">&gt;</span>           The full path to logfile created by <span class="pl-s"><span class="pl-pds">'</span>check_drupal<span class="pl-pds">'</span></span>

  --help                 Show this <span class="pl-c1">help</span>
  --version              Show version information.</pre></div>

<h2>
<a id="2-examples" class="anchor" href="#2-examples" aria-hidden="true"><span class="octicon octicon-link"></span></a>2. Examples</h2>

<p>The following examples are run directly from the command line. The exit code will always be aggregated, meaning if the program throws a warning and an error, the final exit code will result in an error.</p>

<p>Also to note: The first line until the <code>|</code> represents the actual nagios output. Everything in the first line behind the <code>|</code> is performance data used to generate the cool charts. Everything from line two onwards is nagios extended status info (when you click on details).</p>

<p><strong>Check for security updates</strong></p>

<div class="highlight highlight-source-shell"><pre>./check_drupal -d /shared/httpd/sites-drupal/COOL-PROJECT/drupal/ -n COOL-PROJECT -s e
[ERROR] COOL-PROJECT has errors: Security update(s) <span class="pl-k">|</span> <span class="pl-s"><span class="pl-pds">'</span>OK<span class="pl-pds">'</span></span>=0<span class="pl-k">;;;</span>0<span class="pl-k">;</span>1 <span class="pl-s"><span class="pl-pds">'</span>Errors<span class="pl-pds">'</span></span>=1<span class="pl-k">;</span>1<span class="pl-k">;</span>1<span class="pl-k">;</span>0<span class="pl-k">;</span>1 <span class="pl-s"><span class="pl-pds">'</span>Warnings<span class="pl-pds">'</span></span>=0<span class="pl-k">;</span>1<span class="pl-k">;;</span>0<span class="pl-k">;</span>1 <span class="pl-s"><span class="pl-pds">'</span>Unknown<span class="pl-pds">'</span></span>=0<span class="pl-k">;;;</span>0<span class="pl-k">;</span>1
==== SECURITY UPDATES ====
[CRITICAL] drupal 7.40 -<span class="pl-k">&gt;</span> 7.41
[CRITICAL] jquery_update 7.x-2.6 -<span class="pl-k">&gt;</span> 7.x-2.7</pre></div>

<p><strong>Check for security and normal updates</strong></p>

<div class="highlight highlight-source-shell"><pre>./check_drupal -d /shared/httpd/sites-drupal/COOL-PROJECT/drupal/ -n COOL-PROJECT -s e -u w
[ERROR] COOL-PROJECT has errors: Security update(s), Update(s) <span class="pl-k">|</span> <span class="pl-s"><span class="pl-pds">'</span>OK<span class="pl-pds">'</span></span>=0<span class="pl-k">;;;</span>0<span class="pl-k">;</span>2 <span class="pl-s"><span class="pl-pds">'</span>Errors<span class="pl-pds">'</span></span>=1<span class="pl-k">;</span>1<span class="pl-k">;</span>1<span class="pl-k">;</span>0<span class="pl-k">;</span>2 <span class="pl-s"><span class="pl-pds">'</span>Warnings<span class="pl-pds">'</span></span>=1<span class="pl-k">;</span>1<span class="pl-k">;;</span>0<span class="pl-k">;</span>2 <span class="pl-s"><span class="pl-pds">'</span>Unknown<span class="pl-pds">'</span></span>=0<span class="pl-k">;;;</span>0<span class="pl-k">;</span>2
==== SECURITY UPDATES ====
[CRITICAL] drupal 7.40 -<span class="pl-k">&gt;</span> 7.41
[CRITICAL] jquery_update 7.x-2.6 -<span class="pl-k">&gt;</span> 7.x-2.7
==== SYSTEM UPDATES ====
[WARNING] field_collection 7.x-1.0-beta9 -<span class="pl-k">&gt;</span> 7.x-1.0-beta10
[WARNING] views 7.x-3.11 -<span class="pl-k">&gt;</span> 7.x-3.13
[WARNING] bootstrap 7.x-3.0 -<span class="pl-k">&gt;</span> 7.x-3.1</pre></div>

<p><strong>Check for all possible stuff</strong></p>

<div class="highlight highlight-source-shell"><pre>./check_drupal -d /shared/httpd/sites-drupal/COOL-PROJECT/drupal/ -n COOL-PROJECT -s e -u w -e e -w w -m e
[ERROR] COOL-PROJECT has errors: Security update(s), Update(s), Core error(s), Core warning(s) <span class="pl-k">|</span> <span class="pl-s"><span class="pl-pds">'</span>OK<span class="pl-pds">'</span></span>=1<span class="pl-k">;;;</span>0<span class="pl-k">;</span>5 <span class="pl-s"><span class="pl-pds">'</span>Errors<span class="pl-pds">'</span></span>=2<span class="pl-k">;</span>1<span class="pl-k">;</span>1<span class="pl-k">;</span>0<span class="pl-k">;</span>5 <span class="pl-s"><span class="pl-pds">'</span>Warnings<span class="pl-pds">'</span></span>=2<span class="pl-k">;</span>1<span class="pl-k">;;</span>0<span class="pl-k">;</span>5 <span class="pl-s"><span class="pl-pds">'</span>Unknown<span class="pl-pds">'</span></span>=0<span class="pl-k">;;;</span>0<span class="pl-k">;</span>5
==== SECURITY UPDATES ====
[CRITICAL] drupal 7.40 -<span class="pl-k">&gt;</span> 7.41
[CRITICAL] jquery_update 7.x-2.6 -<span class="pl-k">&gt;</span> 7.x-2.7
==== SYSTEM UPDATES ====
[WARNING] field_collection 7.x-1.0-beta9 -<span class="pl-k">&gt;</span> 7.x-1.0-beta10
[WARNING] views 7.x-3.11 -<span class="pl-k">&gt;</span> 7.x-3.13
[WARNING] bootstrap 7.x-3.0 -<span class="pl-k">&gt;</span> 7.x-3.1
==== CORE ERRORS ====
[CRITICAL] CKeditor
[CRITICAL] Cron-Wartungsaufgaben
[CRITICAL] CTools CSS Cache
[CRITICAL] Aktualisierungsstatus von Modulen und Themes
[CRITICAL] Aktualisierungsstatus des Drupal-Kern
==== CORE WARNINGS ====
[WARNING] Token
==== DB UPDATES ====
[OK] No database updates required</pre></div>

<p><strong>Check for db updates</strong></p>

<div class="highlight highlight-source-shell"><pre>./check_drupal -d /shared/httpd/sites-drupal/COOL-PROJECT/drupal/ -n COOL-PROJECT -m e
[OK] COOL-PROJECT is healthy <span class="pl-k">|</span> <span class="pl-s"><span class="pl-pds">'</span>OK<span class="pl-pds">'</span></span>=1<span class="pl-k">;;;</span>0<span class="pl-k">;</span>1 <span class="pl-s"><span class="pl-pds">'</span>Errors<span class="pl-pds">'</span></span>=0<span class="pl-k">;</span>1<span class="pl-k">;</span>1<span class="pl-k">;</span>0<span class="pl-k">;</span>1 <span class="pl-s"><span class="pl-pds">'</span>Warnings<span class="pl-pds">'</span></span>=0<span class="pl-k">;</span>1<span class="pl-k">;;</span>0<span class="pl-k">;</span>1 <span class="pl-s"><span class="pl-pds">'</span>Unknown<span class="pl-pds">'</span></span>=0<span class="pl-k">;;;</span>0<span class="pl-k">;</span>1
==== DB UPDATES ====
[OK] No database updates required</pre></div>

<h2>
<a id="3-nagios-configuration" class="anchor" href="#3-nagios-configuration" aria-hidden="true"><span class="octicon octicon-link"></span></a>3. Nagios Configuration</h2>

<h3>
<a id="31-check_drupal" class="anchor" href="#31-check_drupal" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.1 check_drupal</h3>

<h4>
<a id="command-definition" class="anchor" href="#command-definition" aria-hidden="true"><span class="octicon octicon-link"></span></a>Command definition</h4>

<p>In order to check drupal sites on remote servers you will need to make use of <code>check_by_ssh</code>.</p>

<div class="highlight highlight-source-shell"><pre>name:    check_by_ssh_drupal
<span class="pl-c1">command</span>: <span class="pl-smi">$USER1</span>$/check_by_ssh -H <span class="pl-smi">$HOSTADDRESS</span>$ -t 60 -l <span class="pl-s"><span class="pl-pds">"</span><span class="pl-smi">$USER17</span>$<span class="pl-pds">"</span></span> -C <span class="pl-s"><span class="pl-pds">"</span><span class="pl-smi">$USER22</span>$/check_drupal -d <span class="pl-smi">$ARG1</span>$ -n <span class="pl-smi">$ARG2</span>$ <span class="pl-smi">$ARG3</span>$<span class="pl-pds">"</span></span></pre></div>

<h4>
<a id="service-definition" class="anchor" href="#service-definition" aria-hidden="true"><span class="octicon octicon-link"></span></a>Service definition</h4>

<p>In the above command definition there are two fixed arguments for the document root and the project name as well as one loose argument place holder that can hold all checks you want to run. The following shows one example service definition for one specific drupal site:</p>

<div class="highlight highlight-source-shell"><pre>check <span class="pl-c1">command</span>: ssh_drupal_cool-drupal-project
<span class="pl-smi">$ARG1</span>$:        /var/www/cool-drupal-project/drupal/
<span class="pl-smi">$ARG2</span>$:        Cool Drupal Project
<span class="pl-smi">$ARG3</span>$:        -s e -u w -e e -w w -m e</pre></div>

<p>The above service defintion will check against security updates (with nagios error), against normal updates (with nagios warning), against core errors (with nagios error), against core warnings (with nagios warning) and finally against missed database updates (with nagios error).</p>

<h3>
<a id="32-check_drupal_log" class="anchor" href="#32-check_drupal_log" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.2 check_drupal_log</h3>

<h4>
<a id="command-definition-1" class="anchor" href="#command-definition-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Command definition</h4>

<p>In order to check drupal sites on remote servers you will need to make use of <code>check_by_ssh</code>.</p>

<div class="highlight highlight-source-shell"><pre>name:    check_by_ssh_drupal
<span class="pl-c1">command</span>: <span class="pl-smi">$USER1</span>$/check_by_ssh -H <span class="pl-smi">$HOSTADDRESS</span>$ -t 60 -l <span class="pl-s"><span class="pl-pds">"</span><span class="pl-smi">$USER17</span>$<span class="pl-pds">"</span></span> -C <span class="pl-s"><span class="pl-pds">"</span><span class="pl-smi">$USER22</span>$/check_drupal_log -f <span class="pl-smi">$ARG1</span>$<span class="pl-pds">"</span></span></pre></div>

<h4>
<a id="service-definition-1" class="anchor" href="#service-definition-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Service definition</h4>

<p>In the above command definition there is only one arguments. This will point to the logfile created by <code>check_drupal</code>:</p>

<div class="highlight highlight-source-shell"><pre>check <span class="pl-c1">command</span>: ssh_drupal_cool-drupal-project
<span class="pl-smi">$ARG1</span>$:        /var/log/drupal_cool-project.log</pre></div>

<h4>
<a id="cron-setup" class="anchor" href="#cron-setup" aria-hidden="true"><span class="octicon octicon-link"></span></a>Cron setup</h4>

<p>For this recommended setup to work you need to setup a cronjob on the target machine (where the drupal site is installed) that is run every 6 hours, every day or whatever you want.</p>

<p>Setup multiple cronjobs with multiple logfiles if you have multiple drupal sites on this machine that you want to monitor.</p>

<pre lang="cron"><code>0 */6 * * * /path/to/check_drupal -d /var/www/cool-drupal-project/drupal/ -n "Cool Project" -s e -u w -e e -w w -m e -l /var/log/drupal_cool-project.log
</code></pre>

<h2>
<a id="4-license" class="anchor" href="#4-license" aria-hidden="true"><span class="octicon octicon-link"></span></a>4. License</h2>

<p><a href="http://opensource.org/licenses/mit"><img src="https://poser.pugx.org/cytopia/check_drupal/license" alt="license"></a></p>

<h2>
<a id="5-awesome" class="anchor" href="#5-awesome" aria-hidden="true"><span class="octicon octicon-link"></span></a>5. Awesome</h2>

<p>Added by the following <a href="https://github.com/sindresorhus/awesome"><img src="https://cdn.rawgit.com/sindresorhus/awesome/d7305f38d29fed78fa85652e3a63e154dd8e8829/media/badge.svg" alt="Awesome"></a> lists:</p>

<ul>
<li><a href="https://github.com/cytopia/awesome-nagios-plugins">awesome-nagios-plugins</a></li>
</ul>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/cytopia/check_drupal">Check drupal</a> is maintained by <a href="https://github.com/cytopia">cytopia</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
